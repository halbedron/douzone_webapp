<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorator="layout/default" lang="ko">
<div  layout:fragment="content">
	<div class="container-fluid" >
		<div th:text="${jsonObj}"  id="confirmation_data" style="display: none;"></div>
		<div th:text="${imageData}"  id="image_data" style="display: none;"></div>
		<div class="row"  style="padding-top: 21%;">
			<div class="col-xs-offset-1 col-xs-10 table-bordered" style="padding-bottom: 10px;" id="confirmation_text">
				<div class="row" style="padding-left: 15px; padding-right: 15px;">
				<div class="row" >
					<h2 class="text-center" id="confirmation_title">종돈 입식 확인서</h2>
				</div>
				<div class="row">
					<div class="col-xs-11"  style="border-bottom: 1px solid #d3d3d3; margin-left: 15px"></div>
				</div>
				<div class="row" style="padding-left: 20px;">
					<h3 class="col-xs-10"  id="confirmation_company">(주)다비육종</h3>
					<h4 class="col-xs-12"  id="confirmation_addr_01"></h4>
					<h4 class="col-xs-12"  id="confirmation_addr_02"></h4>
					<h4 class="col-xs-12"  id="confirmation_call">전화 031-672-5660</h4>
					<h4 class="col-xs-12"  id="confirmation_fax">팩스 031-672-6232</h4>
				</div>
				<div class="row">
					<div class="col-xs-11"  style="border-bottom: 1px solid #d3d3d3; margin-left: 15px"></div>
				</div>
				<form class="form-horizontal" >
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>입식일자 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3 id="enterDate"></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>거래처명 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3 id="accountName"></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>품목 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3 id="item"></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>두수 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3><span id="numberOfHeads"></span>    <span id="unit_qty_sale">(두)</span></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>체중 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3 ><span id="weght"></span><span id="unit_wei_sale">(kg)</span></h3>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-11"  style="border-bottom: 1px solid #d3d3d3; margin-left: 15px"></div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>항생제명 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3><span id="antibiotic_name"></span></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>용량 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3 ><span id="capacity"></span> <span id="unit_antibio">(ml)</span></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>휴약일수 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3><span id="withdrawal"></span> <span id="unit_days_vaccine">(일)</span></h3>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-11"  style="border-bottom: 1px solid #d3d3d3; margin-left: 15px"></div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>물류담당 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3><span id="distributionCharge"></span></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>차량번호 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3><span id="carNum"></span></h3>
						</div>
					</div>
					<div class="row">
						<h4 class="col-xs-5 col-sm-4 control-label " ><strong>영업담당 :</strong></h4>
						<div class="col-xs-7 col-sm-8 pad-left-0">
							<h3><span id="salesCharge"></span></h3>
							<h3><span id="salesChargeNum"></span></h3>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-11"  style="border-bottom: 1px solid #d3d3d3; margin-left: 15px"></div>
					</div>
					<div class="row">
						<h4 class="col-xs-6 col-sm-6 control-label "  style="padding-right: 0;"><strong id="label_histcall_text"></strong></h4>
						<div class="col-xs-6 col-sm-6 pad-left-0" style="padding-right: 0;">
							<h4 class="control-label " ><strong>(</strong><i class="fa fa-phone "></i><strong id="label_histcall_no"></strong></h4>
						</div>
					</div>
					<div class="row">
						<h3><span class="col-xs-offset-4 col-xs-8 col-sm-offset-4 col-sm-8" id="no_hist"></span></h3>
					</div>
				</form>
				<div class="row">
					<div class="col-xs-11"  style="border-bottom: 1px solid #d3d3d3; margin-left: 15px"></div>
				</div>
				<div class="row">
					<h3 class="col-xs-12 col-sm-12 control-label" ><strong>전자서명&nbsp; :  </strong></h3>
				</div>
				</div>
				<div class="row">
					<img id="signImg" style="width: 100%; height: 170px;" />
				</div>
			</div>
		</div>
		<div class="row" style="margin: 16px 2px 10px; padding-left: 20px;">
			<div class="col-xs-12  btn-group ">
				<button type="button"  class="btn btn-default"  id="confirmation_pre_view"  >
					<i class="fa fa-chevron-left"  aria-hidden="true" ></i>&nbsp;
					이전
				</button>
				<button type="button" class="btn btn-default"  data-toggle="modal" data-target="#confirmationOutput" id="output_img">
					<i class="fa fa-floppy-o"  aria-hidden="true" ></i>&nbsp;이미지 저장
				</button>
				<button type="button" class="btn btn-info"  id="output_print">
					<i class="fa fa-print" aria-hidden="true"></i>&nbsp;출력
				</button>
			</div>
		</div>
		<div class="row text-center" style="margin-bottom: 16px;">
			<button type="button"  class="btn btn-default"  id="connect_print"  >
				<i class="fa fa-plug" aria-hidden="true"></i>&nbsp;
				프린터 연결
			</button>
		</div>
		<div class="modal fade"  id="confirmationOutput">
		  <div class="modal-dialog">
		    <div class="modal-content">
		      <div class="modal-header">
		        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
		        <h3 class="modal-title" id="mapAddr"></h3>
		      </div>
		      <div class="modal-body">
		        <img id="confirmationImg"  style="width: 100%"/>
		      </div>
		      <div class="modal-footer">
		        <button type="button" class="btn btn-info" data-dismiss="modal">닫기</button>
		      </div>
		    </div><!-- /.modal-content -->
		  </div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
	</div>
<style>
h4, h3 {
	margin: 5px 0 5px 0 ;
}
</style>
<script src="https://unpkg.com/merge-images"></script>
<script th:inline="javascript">
/*<![CDATA[*/
var confirmation = {
		data: null,
		sign: null,
		context: null,
		src: null,
}
$(document).ready(function() {
	confirmationFormInit();
	setTimeout(function(){ 
		html2canvas(document.querySelector('#confirmation_text')).then(canvas => {
			setTimeout(function(){ 
				var cavImgStr = canvas.toDataURL('image/png', 1.0);
				
				var str = confirmation.data.IMG_SIGN_FILE.replace(".jpg", "");
				var cd_company = str.substring(0, 4);
				var no_ship_plan = str.substring(4, 16);
				var cd_partner = str.substring(16, 21);
				$.post('/canv/confirmationUploadProc'
					, {strImg : cavImgStr, cd_company: cd_company, no_ship_plan: no_ship_plan, cd_partner: cd_partner}
					, function(data) {
						confirmation.src = 'http://1.244.192.47:85/ERP-U/Upload/ship_confirmation/' + confirmation.data.IMG_SIGN_FILE.replace("jpg", "png")
				});
			}, 400);
		});
	}, 300);
});

function confirmationFormInit() {
	setTitle("종돈 입식 확인서");
	confirmationFormGetData();
	confirmationFormEventBind();
}

function confirmationFormGetData() {
	var getData = JSON.parse($("#confirmation_data").text()).paramJson;
	confirmation.sign = sessionStorage.getItem("sign");
	var bodyObj = new Object();
	bodyObj.FunctionID = "UP_CG_MOB_SHIP_CHECK_R";
	bodyObj.P_CD_COMPANY = userInfo().CD_COMPANY;
	bodyObj.P_no_ship_plan = getData.no_ship_plan;
	bodyObj.p_cd_partner = getData.cd_partner;
	
	commonAjaxForGetData(bodyObj, function(data) {
		confirmation.data = data.UP_CG_MOB_SHIP_CHECK_R[0];
		confirmationFormSetData(confirmation.data);
	});
}

function confirmationFormSetData(data) {
	if(data != null && data != []) {
		$("#confirmation_title").text("");
		$("#confirmation_title").text(data.LALEL_TITLE);
		
		addr = data.ADS_H.split(" ");
		$("#confirmation_addr_01").text("");
		$("#confirmation_addr_01").text(addr[0] + " " + addr[1] + " " + addr[2]);
		$("#confirmation_addr_02").text("");
		$("#confirmation_addr_02").text(addr[3] + " " + addr[4]);
	
		$("#confirmation_call").text("");
		$("#confirmation_call").text(data.LABEL_TEL + " " + data.NO_TEL);
		
// 		$("#confirmation_fax").text("");
// 		$("#confirmation_fax").text(data.LABEL_FAX + " " + data.NO_FAX);
		
		var shippingDate = data.DT_SHIP.substring(0,4)+"-"+data.DT_SHIP.substring(4,6)+"-"+data.DT_SHIP.substring(6,8);
		$("#enterDate").text("");
		$("#enterDate").text(shippingDate);
		
		$("#accountName").text("");
		$("#accountName").text(data.NM_PARTNER);
		
		$("#item").text("");
		$("#item").text(data.NM_ITEM);
		
		$("#numberOfHeads").text("");
		$("#numberOfHeads").text(data.QTY_SALE);
		$("#unit_qty_sale").text("");
		$("#unit_qty_sale").text(data.UNIT_QTY_SALE);
		
		$("#weght").text("");
		$("#weght").text(data.WEI_SALE);
		$("#unit_wei_sale").text("");
		$("#unit_wei_sale").text(data.UNIT_WEI_SALE);
		
		$("#antibiotic_name").text("");
		$("#antibiotic_name").text(data.NM_ANTIBIO);
		
		$("#capacity").text("");
		$("#capacity").text(data.QTY_ANTIBIO);
		$("#unit_antibio").text("");
		$("#unit_antibio").text(data.UNIT_ANTIBIO);
		
		$("#withdrawal").text("");
		$("#withdrawal").text(data.DAYS_VACCINE);
		$("#unit_days_vaccine").text("");
		$("#unit_days_vaccine").text(data.UNIT_DAYS_VACCINE);
		
		$("#distributionCharge").text("");
		$("#distributionCharge").text(data.NM_DRIVER); 
		
		$("#carNum").text("");
		$("#carNum").text(data.NO_CAR);
		
		var nmSalesArr = data.NM_SALE.split(" ")
		$("#salesCharge").text("");
		$("#salesCharge").text(nmSalesArr[0] + " " + nmSalesArr[1]);

		$("#salesChargeNum").text("");
		$("#salesChargeNum").text(nmSalesArr[2]);
		
		var histCallArr = data.LABEL_HISTCALL.replace(":", "").split("(");
		$("#label_histcall_text").text("");
		$("#label_histcall_text").text(histCallArr[0] + " 번호 :");
		
		$("#label_histcall_no").text("");
		$("#label_histcall_no").text(" " + histCallArr[1]);
		
		$("#no_hist").text("");
		$("#no_hist").text(data.NO_HIST);
		
		var sign_img_data = $("#image_data").text();
		sign_img_data = sign_img_data.replace(/_/gi, '/').replace(/-/gi, '+');

		var sign_img_data_str = "data:image/png;base64," + sign_img_data + "=";
		
		var img = new Image;
		img.addEventListener('load', function(e) {
			$("#signImg").attr("src", sign_img_data_str);
		});
		
		img.addEventListener('error', function(e) {
			var img2 = new Image;
			sign_img_data_str = sign_img_data_str+"=";
			
			img2.addEventListener('load', function(e) {
				$("#signImg").attr("src", sign_img_data_str);
			});
			
			img2.addEventListener('error', function(e) {
				var img2 = new Image;
				$("#signImg").attr("src", sign_img_data_str.replace("==", ""));
			});
			img2.src = sign_img_data_str;
		});
		
		img.src = sign_img_data_str;
		
	}
}

function confirmationFormEventBind() {
	$("#output_img").click(function() {
		$("#confirmationImg").attr('src', confirmation.src);
	});
	
	$("#confirmation_pre_view").click(function() {
		sessionStorage.removeItem("sign");
		history.back();
	});
	
	$("#output_print").click(function() {
// 		alert(confirmation.src)
		if(confirmation.src == null) {
			bootalert("다시 시도해 주세요.");
		} else {
			location.href = "app://cmd;print;" + confirmation.src;
		}
	});
	
	$("#connect_print").click(function() {
		location.href="app://cmd;bluetoothdevicelist";
	});
}

/*]]>*/
</script>
</div>
</html>